{
  "hash": "d49d11a27fde2853e6463f51168a16bd",
  "result": {
    "markdown": "---\ntitle: 'DLNMs: hypothesis tests and p-values'\n# author: Eric R. Scott\ndate: '2021-01-20'\n# slug: dlnm-p-values\ncategories:\n  - DLNMs\n  - GAMs\n  - r\n# projects: [heliconia]\n---\n\n\n\n\n::: callout-note\nThis is part of series about distributed lag non-linear models.\nPlease read the [first post](/post/dlnm) for an introduction and a disclaimer.\n:::\n\nA major goal of my [postdoc project](/project/heliconia) is to determine whether drought has an effect on plant vital rates (growth, survival, reproduction, recruitment).\nGetting some measure of statistical significance of drought history in these models is therefore really important for me.\nEven with simple linear models, there are multiple ways of doing hypothesis testing, some more \"correct\" than others.\nFor example, this recent Twitter discussion about the default behavior of `anova()` usually being innapropriate:\n\n<blockquote class=\"twitter-tweet\">\n\n<p lang=\"en\" dir=\"ltr\">\n\nEEB folks: when did you realize that <a href=\"https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw\">#rstats</a> uses Type I sums of squares as a default?\nvia <a href=\"https://twitter.com/DanielBolnick?ref_src=twsrc%5Etfw\">@DanielBolnick</a> <br><br>\"before\" means that you ran analyses without realizing but then changed them (e.g., to Type III) before publishing.\n<br><br>\"after\" means you published with it & later realized\n\n</p>\n\n--- Andrew Hendry (@EcoEvoEvoEco) <a href=\"https://twitter.com/EcoEvoEvoEco/status/1355902690254082048?ref_src=twsrc%5Etfw\">January 31, 2021</a>\n\n</blockquote>\n\n\n```{=html}\n<script async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"></script>\n```\n\n## P-values for GAMs\n\nThis [StackExchange answer](https://stats.stackexchange.com/questions/274151/anova-to-compare-models/274632#274632) does a really good job of explaining hypothesis testing with GAMs, and I think this extends to DLNMs fit as GAMs.\nUnlike `anova.lm()` or `summary.lm()`, which are generally **not** the ones you want, the p-values in `anova.gam()` and `summary.gam()` are generally safe to interpret (also, they are exactly the same).\nSimon Wood (the author of `mgcv`) has given a lot of thought and published multiple papers on the calculation of these p-values.[^1]\n[^2] For an ordinary penalized smooth (like the default, thin plant regression splines, or the `\"cr\"` cubic regression spline basis), the actual wiggliness is lower than the maximum wiggliness (defined by the number of knots)\n. This shrinkage toward a straight line (or a plane in the case of a crossbasis function) is expressed by estimated degrees of freedom (edf)\n. For example, if edf `\\(\\simeq\\)` 1, then the smooth is approaching a straight line\n. Let's look at an example\n.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(mgcv)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: nlme\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'nlme'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:dplyr':\n\n    collapse\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThis is mgcv 1.8-42. For overview type 'help(\"mgcv-package\")'.\n```\n:::\n\n```{.r .cell-code}\nlibrary(dlnm)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nThis is dlnm 2.4.7. For details: help(dlnm) and vignette('dlnmOverview').\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ngrowth <-\n  gam(log_size_next ~ \n        s(log_size) +\n        s(spei_history, L, #crossbasis function\n          bs = \"cb\", \n          k = c(3, 24), \n          xt = list(bs = \"cr\")),\n      family = gaussian(link = \"identity\"),\n      method = \"REML\",\n      data = ha)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(growth)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\nlog_size_next ~ s(log_size) + s(spei_history, L, bs = \"cb\", k = c(3, \n    24), xt = list(bs = \"cr\"))\n\nApproximate significance of smooth terms:\n                    edf Ref.df        F p-value\ns(log_size)       1.363  1.644 1441.842  <2e-16\ns(spei_history,L) 7.400  8.847    2.906  0.0019\n```\n:::\n:::\n\n\nThe `edf` for `s(log_size)` is fairly close to 1, indicating that it might be better modeled as a parametric term (i.e. just a slope).\nThe edf for the crossbasis function is higher, indicating a more complex surface.\nThe reference degrees of freedom `Ref.df` is, I think, another way of calculating the edf, but honestly, the explanation in the help file and associated paper is beyond my understanding.\nThe test is a modification of a Wald test that can take fractional degrees of freedom (the edf).\nThe help file indicates that p-values \"may be somewhat too low when smoothing parameters are highly uncertain. High uncertainty happens in particular when smoothing parameters are poorly identified, which can occur with nested smooths or highly correlated covariates (high concurvity)\".\nThis sounds worrying, but I actually don't think it's that different than the situation with a linear model.\nHighly correlated covariates will *also* give you untrustworthy p-values in an ordinary linear regression, so I'm not sure there's anything super different here.\n\n## Shrinkage\n\nIn the GAM I fit above, the most a term can be penalized to is linear, i.e. edf = 1 (ignore the random effect of plot as it is different).\nIf I set `select = TRUE` in the `gam()` call, it adds a second penalty on the \"null space\" and allows edf to go to 0, effectively dropping out of the model entirely.\nAccording to the [StackOverflow answer](https://stats.stackexchange.com/questions/274151/anova-to-compare-models/274632#274632), this is currently the best way to get p-values for GAMs.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngrowth_shrink <-\n  gam(log_size_next ~ \n        s(log_size) +\n        s(spei_history, L, #crossbasis function\n          bs = \"cb\", \n          k = c(3, 24), \n          xt = list(bs = \"cr\")),\n      family = gaussian(link = \"identity\"),\n      method = \"REML\",\n      select = TRUE,\n      data = ha)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(growth_shrink)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nFamily: gaussian \nLink function: identity \n\nFormula:\nlog_size_next ~ s(log_size) + s(spei_history, L, bs = \"cb\", k = c(3, \n    24), xt = list(bs = \"cr\"))\n\nApproximate significance of smooth terms:\n                     edf Ref.df       F  p-value\ns(log_size)        1.348  9.000 262.525  < 2e-16\ns(spei_history,L)  4.558 23.000   1.132 2.33e-05\n```\n:::\n:::\n\n\nAll of the edf are smaller, but the `Ref.df` have gone up, and are now whole numbers.\nThis is to correct for having done variable selection, I think.\nUsually it is a bad idea to do variable selection and then do `Anova()` on the final model---the p-values will be biased since you've already pulled terms out of your model.\nSo instead of getting estimated reference degrees of freedom, we now get something like the number of knots - 1 (although that's not exactly what it is for the crossbasis function).\n\nThe test is still a null hypothesis test ($s(x) = 0$), but now terms are allowed to be dropped from the model completely, if they are not supported by the data.\n\n## Visualizing Shrinkage\n\nI'm going to use the [`gratia`](https://github.com/gavinsimpson/gratia/) package to plot the smooths from the shrinkage and non-shrinkage versions.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(gratia)\ndraw(growth)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndraw(growth_shrink)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nThere's really no difference in the shape of `s(log_size)` meaning that the relationship really is log-linear, but that the term *should* stay in the model.\nThe surface for the lagged drought effect is similar in shape, but slightly *flatter* in the shrinkage penalized version, just as we'd expect from the edf being lower.\n\n\n{{< downloadthis index.Rmd dname=\"index.Rmd\" label=\"Download Rmd\" >}}\n\n\n\n[^1]: Wood SN (2013) On p-values for smooth components of an extended generalized additive model.\n    Biometrika 100:221--228 .\n    <https://doi.org/10.1093/biomet/ass048>\n\n[^2]: Marra G, Wood SN (2011) Practical variable selection for generalized additive models.\n    Computational Statistics & Data Analysis 55:2372--2387 .\n    <https://doi.org/10.1016/j.csda.2011.02.004>\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}